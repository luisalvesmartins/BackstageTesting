{"version":3,"file":"response-body-validation.cjs.js","sources":["../../src/schema/response-body-validation.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { JsonObject } from '@backstage/types';\nimport { Operation, ParserOptions, ResponseParser } from './types';\nimport {\n  OperationError,\n  OperationParsingResponseError,\n  OperationResponseError,\n} from './errors';\nimport Ajv from 'ajv';\nimport { OperationObject, ResponseObject } from 'openapi3-ts';\n\nclass DisabledResponseBodyParser\n  implements ResponseParser<JsonObject | undefined>\n{\n  operation: Operation;\n  constructor(operation: Operation) {\n    this.operation = operation;\n  }\n  async parse(response: Response): Promise<JsonObject | undefined> {\n    const body = await response.text();\n    if (body?.length) {\n      throw new OperationError(\n        this.operation,\n        'Received a body but no schema was found',\n      );\n    }\n    return undefined;\n  }\n}\n\nexport class ResponseBodyParser\n  implements ResponseParser<JsonObject | undefined>\n{\n  operation: Operation;\n  ajv: Ajv;\n\n  static fromOperation(operation: Operation, options: ParserOptions) {\n    return operation.schema.responses &&\n      Object.keys(operation.schema.responses).length\n      ? new ResponseBodyParser(operation, options)\n      : new DisabledResponseBodyParser(operation);\n  }\n\n  constructor(operation: Operation, options: ParserOptions) {\n    this.operation = operation;\n    this.ajv = options.ajv;\n    const responseSchemas = operation.schema.responses;\n    for (const [statusCode, schema] of Object.entries(responseSchemas)) {\n      const contentTypes = schema.content;\n      if (!contentTypes) {\n        // Skip responses without content, eg 204 No Content.\n        continue;\n      }\n      const jsonContentType = Object.keys(contentTypes).find(contentType =>\n        contentType.split(';').includes('application/json'),\n      );\n      if (!jsonContentType) {\n        throw new OperationError(\n          this.operation,\n          `No application/json content type found in response for status code ${statusCode}`,\n        );\n      } else if ('$ref' in contentTypes[jsonContentType].schema) {\n        throw new OperationError(\n          this.operation,\n          'Reference objects are not supported',\n        );\n      }\n    }\n  }\n\n  async parse(response: Response): Promise<JsonObject | undefined> {\n    const body = await response.text();\n    const responseSchema = this.findResponseSchema(\n      this.operation.schema,\n      response,\n    );\n    if (!responseSchema?.content && !body?.length) {\n      // If there is no content in the response schema and no body in the response, then the response is valid.\n      // eg 204 No Content\n      return undefined;\n    }\n    if (!responseSchema) {\n      throw new OperationResponseError(\n        this.operation,\n        response,\n        `No schema found.`,\n      );\n    }\n\n    const contentTypes = responseSchema.content;\n    if (!contentTypes && body?.length) {\n      throw new OperationResponseError(\n        this.operation,\n        response,\n        'Received a body but no schema was found',\n      );\n    }\n    const jsonContentType = Object.keys(contentTypes ?? {}).find(contentType =>\n      contentType.split(';').includes('application/json'),\n    );\n    if (!jsonContentType) {\n      throw new OperationResponseError(\n        this.operation,\n        response,\n        'No application/json content type found in response',\n      );\n    }\n    const schema = responseSchema.content![jsonContentType].schema;\n    // This is a bit of type laziness. Ideally, this would be a type-narrowing function, but I wasn't able to get the types to work.\n    if (!schema) {\n      throw new OperationError(this.operation, 'No schema found in response');\n    }\n    if ('$ref' in schema) {\n      throw new OperationResponseError(\n        this.operation,\n        response,\n        'Reference objects are not supported',\n      );\n    }\n\n    if (!schema.required && !body?.length) {\n      throw new OperationResponseError(\n        this.operation,\n        response,\n        'Response body is required but missing',\n      );\n    } else if (!schema.required && !body?.length) {\n      // If there is no content in the response schema and no body in the response, then the response is valid\n      return undefined;\n    }\n\n    const validate = this.ajv.compile(schema);\n    const jsonBody = (await response.json()) as JsonObject;\n    const valid = validate(jsonBody);\n    if (!valid) {\n      throw new OperationParsingResponseError(\n        this.operation,\n        response,\n        'Response body',\n        validate.errors!,\n      );\n    }\n    return jsonBody;\n  }\n\n  private findResponseSchema(\n    operationSchema: OperationObject,\n    { status }: Response,\n  ): ResponseObject | undefined {\n    return (\n      operationSchema.responses?.[status] ?? operationSchema.responses?.default\n    );\n  }\n}\n"],"names":["OperationError","OperationResponseError","OperationParsingResponseError"],"mappings":"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"}