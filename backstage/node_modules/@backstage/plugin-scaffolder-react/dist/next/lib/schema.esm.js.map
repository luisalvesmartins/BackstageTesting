{"version":3,"file":"schema.esm.js","sources":["../../../src/next/lib/schema.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { JsonObject } from '@backstage/types';\nimport { stringify, parse } from 'flatted';\nimport { FieldValidation, UiSchema } from '@rjsf/utils';\n\nfunction isObject(value: unknown): value is JsonObject {\n  return typeof value === 'object' && value !== null && !Array.isArray(value);\n}\n\nfunction extractUiSchema(schema: JsonObject, uiSchema: JsonObject) {\n  if (!isObject(schema)) {\n    return;\n  }\n\n  const {\n    properties,\n    items,\n    anyOf,\n    oneOf,\n    allOf,\n    dependencies,\n    then,\n    else: _else,\n  } = schema;\n\n  for (const propName in schema) {\n    if (!schema.hasOwnProperty(propName)) {\n      continue;\n    }\n\n    if (propName.startsWith('ui:')) {\n      uiSchema[propName] = schema[propName];\n      delete schema[propName];\n    }\n  }\n\n  if (isObject(properties)) {\n    for (const propName in properties) {\n      if (!properties.hasOwnProperty(propName)) {\n        continue;\n      }\n\n      const schemaNode = properties[propName];\n      if (!isObject(schemaNode)) {\n        continue;\n      }\n\n      if (!isObject(uiSchema[propName])) {\n        const innerUiSchema = {};\n        uiSchema[propName] = innerUiSchema;\n      }\n\n      extractUiSchema(schemaNode, uiSchema[propName] as JsonObject);\n    }\n  }\n\n  if (isObject(items)) {\n    const innerUiSchema = {};\n    uiSchema.items = innerUiSchema;\n    extractUiSchema(items, innerUiSchema);\n  }\n\n  if (Array.isArray(anyOf)) {\n    for (const schemaNode of anyOf) {\n      if (!isObject(schemaNode)) {\n        continue;\n      }\n      extractUiSchema(schemaNode, uiSchema);\n    }\n  }\n\n  if (Array.isArray(oneOf)) {\n    for (const schemaNode of oneOf) {\n      if (!isObject(schemaNode)) {\n        continue;\n      }\n      extractUiSchema(schemaNode, uiSchema);\n    }\n  }\n\n  if (Array.isArray(allOf)) {\n    for (const schemaNode of allOf) {\n      if (!isObject(schemaNode)) {\n        continue;\n      }\n      extractUiSchema(schemaNode, uiSchema);\n    }\n  }\n\n  if (isObject(dependencies)) {\n    for (const depName of Object.keys(dependencies)) {\n      const schemaNode = dependencies[depName];\n      if (!isObject(schemaNode)) {\n        continue;\n      }\n      extractUiSchema(schemaNode, uiSchema);\n    }\n  }\n\n  if (isObject(then)) {\n    extractUiSchema(then, uiSchema);\n  }\n\n  if (isObject(_else)) {\n    extractUiSchema(_else, uiSchema);\n  }\n}\n\n/**\n * Takes a step from a Backstage Template Manifest and converts it to a JSON Schema and UI Schema for rjsf\n * @alpha\n */\nexport const extractSchemaFromStep = (\n  inputStep: JsonObject,\n): { uiSchema: UiSchema; schema: JsonObject } => {\n  const uiSchema: UiSchema = {};\n  const returnSchema: JsonObject = parse(stringify(inputStep));\n  extractUiSchema(returnSchema, uiSchema);\n  return { uiSchema, schema: returnSchema };\n};\n\n/**\n * Creates a field validation object for use in react jsonschema form\n * @alpha\n */\nexport const createFieldValidation = (): FieldValidation => {\n  const fieldValidation: FieldValidation = {\n    __errors: [] as string[],\n    addError: (message: string) => {\n      fieldValidation.__errors?.push(message);\n    },\n  };\n\n  return fieldValidation;\n};\n"],"names":[],"mappings":"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"}