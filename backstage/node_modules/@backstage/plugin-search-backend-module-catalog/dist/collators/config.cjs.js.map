{"version":3,"file":"config.cjs.js","sources":["../../src/collators/config.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  SchedulerServiceTaskScheduleDefinition,\n  readSchedulerServiceTaskScheduleDefinitionFromConfig,\n} from '@backstage/backend-plugin-api';\nimport { EntityFilterQuery } from '@backstage/catalog-client';\nimport { Config } from '@backstage/config';\nimport { InputError } from '@backstage/errors';\n\nconst configKey = 'search.collators.catalog';\n\nexport const defaults = {\n  schedule: {\n    frequency: { minutes: 10 },\n    timeout: { minutes: 15 },\n    initialDelay: { seconds: 3 },\n  },\n  collatorOptions: {\n    locationTemplate: '/catalog/:namespace/:kind/:name',\n    filter: undefined,\n    batchSize: 500,\n  },\n};\n\nexport function readScheduleConfigOptions(\n  configRoot: Config,\n): SchedulerServiceTaskScheduleDefinition {\n  let schedule: SchedulerServiceTaskScheduleDefinition | undefined = undefined;\n\n  const config = configRoot.getOptionalConfig(configKey);\n  if (config) {\n    const scheduleConfig = config.getOptionalConfig('schedule');\n    if (scheduleConfig) {\n      try {\n        schedule =\n          readSchedulerServiceTaskScheduleDefinitionFromConfig(scheduleConfig);\n      } catch (error) {\n        throw new InputError(`Invalid schedule at ${configKey}, ${error}`);\n      }\n    }\n  }\n\n  return schedule ?? defaults.schedule;\n}\n\nexport function readCollatorConfigOptions(configRoot: Config): {\n  locationTemplate: string;\n  filter: EntityFilterQuery | undefined;\n  batchSize: number;\n} {\n  const config = configRoot.getOptionalConfig(configKey);\n  if (!config) {\n    return defaults.collatorOptions;\n  }\n\n  return {\n    locationTemplate:\n      config.getOptionalString('locationTemplate') ??\n      defaults.collatorOptions.locationTemplate,\n    filter:\n      config.getOptionalConfig('filter')?.get<EntityFilterQuery>() ??\n      defaults.collatorOptions.filter,\n    batchSize:\n      config.getOptionalNumber('batchSize') ??\n      defaults.collatorOptions.batchSize,\n  };\n}\n"],"names":["readSchedulerServiceTaskScheduleDefinitionFromConfig","InputError"],"mappings":";;;;;AAwBA,MAAM,SAAY,GAAA,0BAAA,CAAA;AAEX,MAAM,QAAW,GAAA;AAAA,EACtB,QAAU,EAAA;AAAA,IACR,SAAA,EAAW,EAAE,OAAA,EAAS,EAAG,EAAA;AAAA,IACzB,OAAA,EAAS,EAAE,OAAA,EAAS,EAAG,EAAA;AAAA,IACvB,YAAA,EAAc,EAAE,OAAA,EAAS,CAAE,EAAA;AAAA,GAC7B;AAAA,EACA,eAAiB,EAAA;AAAA,IACf,gBAAkB,EAAA,iCAAA;AAAA,IAClB,MAAQ,EAAA,KAAA,CAAA;AAAA,IACR,SAAW,EAAA,GAAA;AAAA,GACb;AACF,EAAA;AAEO,SAAS,0BACd,UACwC,EAAA;AACxC,EAAA,IAAI,QAA+D,GAAA,KAAA,CAAA,CAAA;AAEnE,EAAM,MAAA,MAAA,GAAS,UAAW,CAAA,iBAAA,CAAkB,SAAS,CAAA,CAAA;AACrD,EAAA,IAAI,MAAQ,EAAA;AACV,IAAM,MAAA,cAAA,GAAiB,MAAO,CAAA,iBAAA,CAAkB,UAAU,CAAA,CAAA;AAC1D,IAAA,IAAI,cAAgB,EAAA;AAClB,MAAI,IAAA;AACF,QAAA,QAAA,GACEA,sEAAqD,cAAc,CAAA,CAAA;AAAA,eAC9D,KAAO,EAAA;AACd,QAAA,MAAM,IAAIC,iBAAW,CAAA,CAAA,oBAAA,EAAuB,SAAS,CAAA,EAAA,EAAK,KAAK,CAAE,CAAA,CAAA,CAAA;AAAA,OACnE;AAAA,KACF;AAAA,GACF;AAEA,EAAA,OAAO,YAAY,QAAS,CAAA,QAAA,CAAA;AAC9B,CAAA;AAEO,SAAS,0BAA0B,UAIxC,EAAA;AACA,EAAM,MAAA,MAAA,GAAS,UAAW,CAAA,iBAAA,CAAkB,SAAS,CAAA,CAAA;AACrD,EAAA,IAAI,CAAC,MAAQ,EAAA;AACX,IAAA,OAAO,QAAS,CAAA,eAAA,CAAA;AAAA,GAClB;AAEA,EAAO,OAAA;AAAA,IACL,kBACE,MAAO,CAAA,iBAAA,CAAkB,kBAAkB,CAAA,IAC3C,SAAS,eAAgB,CAAA,gBAAA;AAAA,IAC3B,MAAA,EACE,OAAO,iBAAkB,CAAA,QAAQ,GAAG,GAAuB,EAAA,IAC3D,SAAS,eAAgB,CAAA,MAAA;AAAA,IAC3B,WACE,MAAO,CAAA,iBAAA,CAAkB,WAAW,CAAA,IACpC,SAAS,eAAgB,CAAA,SAAA;AAAA,GAC7B,CAAA;AACF;;;;;;"}